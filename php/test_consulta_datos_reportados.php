<?php
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Headers: Origin, Content-Type, X-Auth-Token');

require_once('../config/start.inc.php');
include_once('../class/class.lista.php');
include_once('../class/class.complex.php');
include_once('../class/class.consulta.php');
require_once('../class/html2pdf.class.php');
include_once('../class/NumeroALetra.php');


include_once('../class/class.querybasedatos.php');
include_once('../class/class.http_response.php');
require_once('../class/class.configuracion.php');
include_once('../class/class.mipres.php');

ini_set("memory_limit","32000M");
ini_set('max_execution_time', 0);


$mipres= new Mipres();
$queryObj = new QueryBaseDatos();

/*
$query = 'SELECT F.Codigo, PDM.NoPrescripcion, PDM.ID, PDM.IDDireccionamiento, PDM.IdEntrega, PDM.IdReporteEntrega                                 

FROM Producto_Factura PF
INNER JOIN Factura F ON F.Id_Factura = PF.Id_Factura
LEFT JOIN Producto_Dispensacion PD ON PD.Id_Producto_Dispensacion = PF.Id_Producto_Dispensacion
LEFT JOIN Producto_Dispensacion_Mipres PDM ON PDM.Id_Producto_Dispensacion_Mipres = PD.Id_Producto_Dispensacion_Mipres
WHERE PDM.ID IS NOT NULL AND F.Codigo IN ()

';
    
$oCon= new consulta();
$oCon->setQuery($query);
$oCon->setTipo("Multiple");
$productos = $oCon->getData();
unset($oCon);*/


$pres = ["20190710115013067995",
"20190625160012792620",
"20190724140013341533",
"20190722193013293914",
"20190713163013139366",
"20190618144012655855",
"20190703173012925039",
"20190613110012585821",
"20190605129012411548",
"20190707186012997116",
"20190706114012991673",
"20190712183013113940",
"20190707167012997153",
"20190706151012988301",
"20190706118012987782",
"20190703117012936703",
"20190703167012936909",
"20190705134012972482",
"20190709130013040910",
"20190710143013055891",
"20190703192012916505",
"20190701157012885747",
"20190707198012997102",
"20190712162013114238",
"20190708124013004209",
"20190726144013397363",
"20190702121012911288",
"20190710113013070608",
"20190702199012892703",
"20190808190013648952",
"20190617154012644477",
"20190617190012638211",
"20190613158012585778",
"20190528133012269396",
"20190726125013404449",
"20190708144013025158",
"20190618166012663584",
"20190704183012962816",
"20190710168013078158",
"20190701198012886043",
"20190702126012909140",
"20190701121012885703",
"20190619188012696802",
"20190711115013092971",
"20190626193012805129",
"20190625160012780658",
"20190703160012927496",
"20190617132012646749",
"20190702139012903068",
"20190713141013135634",
"20190710148013076292",
"20190625194012781012",
"20190625171012774144",
"20190731145013484932",
"20190625159012792706",
"20190708243000694725",
"20190630167012883285",
"20190828118014027652",
"20190814197013775915",
"20190626269000682562",
"20190710138013061703",
"20190808141013637829",
"20190713191013135785",
"20190806146013608266",
"20190711116013094658",
"20190727126013423616",
"20190820163013848017",
"20190704192012942472",
"20190809135013664462",
"20190708187013016585",
"20190904126014180657",
"20190725110013375837",
"20190828162014040094",
"20190907147014240157",
"20190820135013864848",
"20190820188013843953",
"20190815191013800523",
"20190821152013888739",
"20190806112013614735",
"20190706199012987919",
"20190717186013209931",
"20190713126013136009",
"20190724196013363965",
"20190904135014184382",
"20190705179012978174",
"20190820174013864872",
"20190830143014089845",
"20190723182013316775",
"20190722196013309555",
"20190717121013209053",
"20190729189013454910",
"20190807136013627389",
"20190823107013926174",
"20190915193014387824",
"20190913155014376066",
"20190824198013946697",
"20190807157013627400",
"20190806192013622553",
"20190801168013534259",
"20190825188013956562",
"20190723110013318423",
"20190809155013666590",
"20190807107013626722",
"20190717113013213347",
"20190710189013078042",
"20190708120013021906",
"20190707181012997026",
"20190820117013864973",
"20190724117013346543",
"20190803189013564236",
"20190821117013890396",
"20190827122014014611",
"20190807122013627780",
"20190708181013021842",
"20190815135013801070",
"20190716146013192024",
"20190723134013317412",
"20190717177013224092",
"20190801110013518786",
"20190710183013077999",
"20190815199013781737",
"20190718117013233446",
"20190725133013371074",
"20190706146012987841",
"20190903110014150611",
"20190726175013401597",
"20190810100013682925",
"20190817134013827665",
"20190902150014128668",
"20190729174013454941",
"20190802178013537755",
"20190815167013789354",
"20190824164013949223",
"20190716199013193951",
"20190806155013624039",
"20190813121013740241",
"20190824114013947619",
"20190817116013831952",
"20190815172013781570",
"20190821126013890296",
"20190603146012356252",
"20190816180013815643",
"20190827181014014662",
"20190812156013719595",
"20190724198013351594",
"20190907191014240374",
"20190717120013207287",
"20190820142013846066",
"20190722173013288462",
"20190806161013609660",
"20190828158014022843",
"20190712193013114263",
"20190807194013627383",
"20190611162012511955",
"20190618169012652189",
"20190826178013966478",
"20190831115014098727",
"20190829168014055122",
"20190823173013939626",
"20190617184012648978",
"20190829196014054686",
"20190828129014023029",
"20190727166013420016",
"20190830193014083462",
"20190712117013127590",
"20190725194013371405",
"20190812170013703452",
"20190830169014070593",
"20190918197014449526",
"20190723192013331938",
"20190906153014231465",
"20190709125013035144",
"20190808163013642420",
"20190811130013689113",
"20190726177013409536",
"20190801183013520728",
"20190801164013511541",
"20190831170014098960",
"20190829193014055019",
"20190717118013225268",
"20190820166013864988",
"20190725116013385416",
"20190716137013180499",
"20190717121013224718",
"20190910185014295666",
"20190902167014107796",
"20190710164013064317",
"20190730166013479029",
"20190716140013200396",
"20190801159013534539",
"20190716115013182330",
"20190719130013263711",
"20190831177014096412",
"20190805128013581443",
"20190909237000795440",
"20190826121013960864",
"20190719128013266174",
"20190726150013414748",
"20190918293000808572",
"20190716112013191859",
"20190727121013421848",
"20190722111013308167",
"20190725140013385940",
"20190722143013306176",
"20190723179013332246",
"20190705191012965043",
"20190801178013534190",
"20190701181012885909",
"20190715134013169588",
"20190731181013484791",
"20190801116013534609",
"20190723126013330964",
"20190706161012987850",
"20190722142013308749",
"20190707148012997140",
"20190723183013331192",
"20190723155013332347",
"20190731197013502723",
"20190713123013134423",
"20190724176013344187",
"20190723190013331640",
"20190708193013025134",
"20190725119013389633",
"20190801117013534146",
"20190724130013342710",
"20190805152013591769",
"20190716194013195063",
"20190731115013493360",
"20190719158013264861",
"20190716171013192405",
"20190622128012761767",
"20190703114012935835",
"20190808166013637546",
"20190712190013112246",
"20190612178012551034",
"20190722141013303686",
"20190717196013208770",
"20190807173013627411",
"20190723115013338653",
"20190731151013500899",
"20190814135013775266",
"20190807191013625789",
"20190715133013151137",
"20190719151013274139",
"20190724131013360508",
"20190807124013626631",
"20190727166013423698",
"20190803173013560317",
"20190710165013075286",
"20190802193013554063",
"20190729190013447644",
"20190718154013246193",
"20190730152013461597",
"20190711183013093912",
"20190727197013418790",
"20190913112014357624",
"20190806143013624057",
"20190830182014089841",
"20190719122013263303",
"20190514119011963854",
"20190605192012411651",
"20190611111012527621",
"20190611121012511534",
"20190611180012507607",
"20190611187012529349",
"20190612155012554235",
"20190613103012576755",
"20190618117012675034",
"20190618194012652766",
"20190619187012697384",
"20190623152012765641",
"20190627195012847087",
"20190628110012869068",
"20190628133012850190",
"20190628158012854354",
"20190628167012856533",
"20190628170012854175",
"20190630196012883267",
"20190702147012908637",
"20190702188012896843",
"20190703151012932286",
"20190703191012912076",
"20190705157012982961",
"20190709131013033049",
"20190710129013062772",
"20190713115013135835",
"20190722130013289756",
"20190722196013309566",
"20190725169013392133",
"20190805190013596817",
"20190808122013639766",
"20190814167013772409",
"20190826184013980349",
"20190827193014007513",
"20190909168014269555",
"20190913247000801828",
"20190627116012846173",
"20190629144012881440",
"20190704131012962823",
"20190718160013252646",
"20190803147013566050",
"20190813189013724765",
"20190904265000789816"

];


foreach($pres as $p){

    //respuesta=$mipres->ConsultaEntregaEfectiva($p);
    $respuesta=$mipres->ConsultaEntrega($p);
    
    //echo json_encode($respuesta); 
    //exit;
    foreach($respuesta as $res){
        
        $oItem = new complex("A_Estado_Reporte_Mipres3","Id_Estado_Reporte_Mipres");
       /* $oItem->ID                  =  $res["ID"];
        $oItem->Prescripcion        =  $res["NoPrescripcion"];
        $oItem->Tipo                =  "ReporteEntrega";
        $oItem->Id_Tipo             =  $res["IDReporteEntrega"];
        $oItem->Fecha_Reporte       =  $res["FecRepEntrega"];
        $oItem->Cantidad_Reportada  =  $res["CantTotEntregada"];
        $oItem->Cum_Reportado       =  $res["CodSerTecEntregado"]; 
        $oItem->Valor_Reportado     =  $res["ValorEntregado"]; 
        $oItem->Estado_Reporte      =  $res["EstRepEntrega"]; 
        $oItem->CausalNoEntrega     =  $res["CausaNoEntrega"]; 
        $oItem->LoteEntregado       =  $res["NoLote"];  
        $oItem->FechaAnulacion      =  $res["FecAnulacion"];*/
        
        $oItem->ID                  =  $res["ID"];
        $oItem->Prescripcion        =  $res["NoPrescripcion"];
        $oItem->Tipo                =  "Entrega";
        $oItem->Id_Tipo             =  $res["IDEntrega"];
        $oItem->Fecha_Reporte       =  $res["FecEntrega"];
        $oItem->Cantidad_Reportada  =  $res["CantTotEntregada"];
        $oItem->Cum_Reportado       =  $res["CodSerTecEntregado"]; 
        
        $oItem->Estado_Reporte      =  $res["EstEntrega"]; 
        $oItem->CausalNoEntrega     =  $res["CausaNoEntrega"]; 
        $oItem->LoteEntregado       =  $res["NoLote"];  
        $oItem->FechaAnulacion      =  $res["FecAnulacion"];
        
        $oItem->save();
        unset($oItem);
        
        echo $res["NoPrescripcion"]." | ".$res["ID"]." | ".$res["IDReporteEntrega"]." | ".$res["EstRepEntrega"]."<br>";
        //echo $res["NoPrescripcion"]."<br>";
    }
    if(count($respuesta)==0){
        echo $p." | NO TIENE NINGUN REPORTE EN MIPRES ASOCIADO<br>";
    }
    
    
}


echo "</table>";
?>