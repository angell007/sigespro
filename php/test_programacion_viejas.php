<?php
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Headers: Origin, Content-Type, X-Auth-Token');

require_once('../config/start.inc.php');
include_once('../class/class.lista.php');
include_once('../class/class.complex.php');
include_once('../class/class.consulta.php');
require_once('../class/html2pdf.class.php');
include_once('../class/NumeroALetra.php');


include_once('../class/class.querybasedatos.php');
include_once('../class/class.http_response.php');
require_once('../class/class.configuracion.php');
include_once('../class/class.mipres.php');

$mipres= new Mipres();
$queryObj = new QueryBaseDatos();

$pres=array('20160603194012356332','20180813252000760501','20190402117011200286','20190402195011200683','20190404185011247001','20190404233000056889','20190404233000560889','20190405187011256571','20190409161011313405','20190409162011331093','20190409163011326887','20190409178011311004','20190409239000569082','20190409284000569039','20190410111011358409','20190410113011342100','20190410130011341831','20190410137011358690','20190410145011358534','20190410197011340830','20190411110011386374','20190411150011370691','20190411153011370259','20190411160011381468','20190411192011371187','20190411193011380162','20190411212000571958','20190411212000571960','20190411219000571946','20190411288000571934','20190411290000571962','20190412121011409230','20190412170011406281','20190412180011404139','20190412195011409350','20190412257000573214','20190412265000573224','20190413136011414901','20190413159011414966','20190413172011419748','20190413175011414799','20190413210000573864','20190413263000573869','20190415134011435909','20190415177011432137','20190415210000575274','20190415221000575288','20190415290000575254','20190415298000575281','20190416110011456389','20190416117011470390','20190416119011451188','20190416129011474702','20190416141011455697','20190416144011474185','20190416148011450921','20190416221000576621','20190416228000576689','20190416233000576673','20190418215000577860','20190418237000577857','20190418240000577856','20190418252000577859','20190418269000577858','20190422111011525982','20190422129011528752','20190423117011534619','20190423120011540048','20190423130011559878','20190423133011555760','20190423140011540991','20190423180011545004','20190424150011562722','20190424177011561825','20190424275000581480','20190424290000582570','20190425107011602386','20190426148011630675','20190427111011642598','20190427152011643868','20190427165011643421','20190427199011642036','20190428113011652150','20190428118011652183','20190428121011652981','20190428131011652926','20190428147011652855','20190428170011652943','20190429110011670023','20190429128011676883','20190429133011668926','20190429136011677340','20190429139011677163','20190429140011674960','20190429147011670257','20190429150011661885','20190429150011681885','20190429159011670639','20190429161011673655','20190429167011674396','20190429172011677070','20190429178011673223','20190429188011672579','20190429195011674174','20190429241000589470','20190429259000589507','20190430111011701001','20190430118011689918','20190430120011705707','20190430121011691493','20190430121011702020','20190430122011699516','20190430123011683261','20190430125011699414','20190430126011695225','20190430126011707121','20190430133011694130','20190430135011689273','20190430137011703139','20190430140011693542','20190430142011693698','20190430142011701572','20190430144011687121','20190430148011685187','20190430150011691065','20190430150011692734','20190430156011704530','20190430161011705160','20190430167011699994','20190430170011705610','20190430177011701112','20190430180011701879','20190430182011703210','20190430186011692329','20190430188011699223','20190430190011683158','20190430199011703041','20190430265000591049','20190430275000590111','20190501250000591247','20190501291000591257','20190501295000591254','20190502107011724486','20190502110011715331','20190502124011715166','20190502132011723707','20190502142011734033','20190502277000593058','20190503138011761061','20190503172011743701','20190503254000594206','20190503254000594208','20190504190011772157','20190504263000595731','20190506116011802140','20190506152011801340','20190506184011792920','20190506190011802280','20190506219000597903','20190506266000597664','20190506272000596358','20190506289000598009','20190506290000597558','20190507143011830962','20190507160011828750','20190507185011831075','20190507197011831129','20190507199011831103','20190507218000598403','20190507262000599920','20190507285000599885','20190507295000599900','20190508110011859289','20190508119011853064','20190508126011859244','20190508133011845444','20190508140011857958','20190508143011842981','20190508150011859889','20190508167011845948','20190508178011840725','20190508183011839344','20190508219000601601','20190508223000601198','20190508269000600515','20190508269000600615','20190508280000601236','20190508285000601340','20190509140011869072','20190509194011866566','20190509213000602362','20190509237000603262','20190509262000603253','20190510151011894412','20190510153011893710','20190510160011887943','20190510181011892756','20190510235000603653','20190511139011914734','20190511266000605292','20190511277000605291','20190513140011940434','20190513185011951139','20190513293000608492','20190514118011956864','20190514119011963853','20190514119011963854','20190514124011978727','20190514135011969933','20190514138011960452','20190514144011954884','20190514145011969083','20190514170011958836','20190514191011959713','20190514247000613497','20190514265000613436','20190514272000613497','20190514288000612150','20190515103012007092','20190515119011986576','20190515122011987744','20190515124011984755','20190515126012000743','20190515147011982499','20190515154012006413','20190515159012000936','20190515176011985054','20190515181011987046','20190515189011981901','20190515192011993756','20190515198011908208','20190515198011988208','20190515198012003248','20190515248000615645','20190515251000614125','20190515278000616391','20190516110012021799','20190516218000621941','20190516237000621796','20190516260000619811','20190516268000621824','20190517234000624952','20190517236000624386','20190517238000624388','20190517242000623878','20190517267000624778','20190517271000623899','20190518132012065541','20190518267000625799','20190518272000625897','20190518290000625838','20190520120012070700','20190520167012071528','20190520175012082639','20190520197012088351','20190520215000629874','20190521111012121556','20190521119012098340','20190521160012102913','20190521162012116742','20190521169012122041','20190521179012107926','20190521192012123006','20190521196012107752','20190521228000633848','20190521230000633979','20190521231000633639','20190521232000633979','20190522112012151898','20190522124012153815','20190522131012148133','20190522168012139169','20190522169012132647','20190522194012136867','20190522194012196867','20190522229000637541','20190522282000637532','20190523123012176368','20190523146012176931','20190523147012177739','20190523166012177098','20190523240000638645','20190523240000638646','20190523244000640887','20190523247000640500','20190523249000640644','20190523263000640527','20190523272000640853','20190523280000640829','20190523284000640612','20190524131012202037','20190524226000643142','20190524285000643138','20190525222000643284','20190525237000643356','20190525261000643255','20190525288000643234','20190525289000643624','20190526132012213661','20190526137012213590','20190527173012233736','20190527195012216354','20190527222000644152','20190527243000645545','20190527250000645566','20190527282000645025','20190528114012250014','20190528119012269357','20190528126012247185','20190528127012249418','20190528133012269396','20190528134012269292','20190528147012268729','20190528162012251661','20190528217000646342','20190528225000647351','20190528227000646015','20190528260000645893','20190528292000645934','20190529153012282537','20190529153012296898','20190529157012287299','20190529177012289844','20190529178012281591','20190529184012278932','20190529194012296965','20190529225000648187','20190529225000648878','20190529237000647530','20190529248000648927','20190529248000648972','20190529250000648968','20190529255000648187','20190529255000648982','20190529264000648914','20190529273000648913','20190529277000648923','20190530113012308020','20190530141012304863','20190530157012313929','20190530197012321996','20190530217000650594','20190530217000650630','20190530242000650365','20190530257000650635','20190530292000650411','20190531124012328231','20190531130012332593','20190531131012328142','20190531140012323008','20190531152012330889','20190531248000651690','20190531252000651269','20190531255000652187','20190531260000652193','20190601143012351741','20190601187012352758','20190601194012352740','20190601233000652259','20190601246000652304','20190601283000652391','20190601285000652355','20190602132012354511','20190602180012354407','20190602180012354861','20190602187012354572','20190602227000652759','20190602281000652764','20190603113012355386','20190603134012356805','20190603154012356096','20190603163012356285','20190603164012356221','20190603167012356181','20190603173012355339','20190603181012356710','20190603187012355351','20190603187012356474','20190603190012356518','20190603194012356332','20190604117012383682','20190604155012360471','20190604156012372881','20190604216000654599','20190604232000654616','20190604249000553140','20190604249000653140','20190604250000653185','20190604284000654530','20190605120012408531','20190605128012402958','20190605129012411548','20190605147012387198','20190605147012406095','20190605162012391396','20190605180012397381','20190605184012407323','20190605192012411651','20190606113012419257','20190606127012414086','20190606139012419533','20190606164012435169','20190606170012435470','20190606170012436156','20190606177012435834','20190606199012412246','20190606233000657737','20190606243000656743','20190606249000657743','20190606280000657025','20190607123012459969','20190607136012449081','20190607139012446792','20190607150012456410','20190607155012459416','20190607164012448084','20190607183012449400','20190607191012454817','20190607214000659317','20190607224000658691','20190607233000659390','20190607268000559304','20190607277000659393','20190607290000559341','20190607290000659341','20190607293000659357','20190608118012471839','20190608123012470394','20190608138012471103','20190608141012470836','20190608154012467135','20190608162012467822','20190608173012471002','20190610113012484112','20190610124012492505','20190610163012487055','20190610173012481452','20190610299000661781','20190611111012527621','20190611112012511682','20190611121012511534','20190611123012508574','20190611128012528059','20190611150012522129','20190611150012528916','20190611161012526973','20190611163012528421','20190611168012519796','20190611178012507045','20190611180012507607','20190611187012512838','20190611187012529349','20190611216000663068','20190611218000664230','20190611219000663010','20190611257000663771','20190611258000664334','20190611262000664145','20190611280000664230','20190611293000664385','20190612130000652391','20190612155012554235','20190612157012557771','20190612177012553541','20190612227000666970','20190612233000667071','20190612237000666633','20190612297000666900','20190612850000652355','20190613103012576755','20190613110012585821','20190613127012567538','20190613149012567910','20190613149012570034','20190613156012566080','20190613158012585778','20190613163012576495','20190613180012565906','20190613181012567432','20190613238000668327','20190613298000675364','20190614137012602174','20190614174012593884','20190614176012604105','20190614233000669912','20190614246000669876','20190614267000670215','20190614270000670227','20190615122012612373','20190617132012646749','20190617154012644477','20190617188012626129','20190617190012638211','20190617211000672263','20190617220000671858','20190617220000671868','20190617263000671815','20190617293000671913','20190618117012675034','20190618144012655855','20190618166012663584','20190618167012657902','20190618174012673840','20190618194012652766','20190618197012671760','20190618244000673777','20190618244000673794','20190618278000673741','20190619141012684816','20190619187012697384','20190619192012700763','20190619196012683227','20190619199012686562','20190619228000675392','20190619238000673880','20190619248000675395','20190619268000675406','20190619271000673889','20190619276000674717','20190619282000675376','20190619298000675364','20190620117012718267','20190620144012718529','20190620168012716043','20190620178012711494','20190620183012711079','20190620212000677108','20190620226000675675','20190620253000677037','20190620260000675748','20190621118012755694','20190621124012754230','20190621133012754173','20190621145012743910','20190621153012744230','20190621163012755626','20190621172012753886','20190621174012754534','20190621181012755216','20190621275000678739','20190623152012765641','20190625140012774802','20190625159012792706','20190625160012780658','20190625160012792620','20190625161012791620','20190625171012774144','20190625183012774548','20190625185012780246','20190625194012781012','20190625216000680301','20190625247000680950','20190625255000680713','20190625278000680637','20190625286000681002','20190625294000679897','20190625294000679997','20190625295000681023','20190626120012800014','20190626193012805129','20190626213000682567','20190626227000682354','20190626239000681842','20190626269000682562','20190626287000682505','20190627116012846173','20190627121012840816','20190627137012825355','20190627154012842886','20190627176012826259','20190627178012831742','20190627195012847087','20190627228000683014','20190627255000684193','20190627293000659357','20190628110012869068','20190628121012872523','20190628133012850190','20190628144012850179','20190628158012854354','20190628167012856533','20190628170012854175','20190628270000685350','20190629144012881440','20190629245000685757','20190629285000685838','20190630167012883285','20190630187012355351','20190630196012883267','20190701121012885703','20190701157012885747','20190701198012886043','20190702126012909140','20190702141012909297','20190702147012908637','20190702199012892703','20190703151012932286','20190703167012936909','20190703173012925039','20190703191012912076','20190703192012916505','20190703236000689309','20190703263000068274','20190703263000689274','20190703293000689252','20190704131012962823','20190704183012962816','20190704268000690910','20190704280000690214','20190704287000690829','20190704297000690560','20190705134012972482','20190705157012982961','20190705226000692586','20190705237000692588','20190705285000692575','20190706114012991673','20190706118012987782','20190706151012988301','20190706217000692590','20190706241000692589','20190706296000693094','20190707167012997153','20190707186012997116','20190707198012997102','20190708144013025158','20190708230000693707','20190708243000694725','20190708253000694792','20190709130013040910','20190709131013033049','20190709220000696102','20190709220000696352','20190709230000693326','20190709274000696449','20190709280000696465','20190709295000696496','20190710110013068049','20190710113013070608','20190710129013062772','20190710138013061703','20190710143013055891','20190710148013076292','20190710168013078158','20190710239000698517','20190710250000697667','20190710261000698501','20190710265000698490','20190710282000698606','20190710293000698228','20190710295000698478','20190711115013092971','20190711244000699772','20190711280000700536','20190711282000700427','20190712162013114238','20190712183013113940','20190712226000702413','20190713115013135835','20190713163013139366','20190713191013135785','20190715230000706164','20190715238000705593','20190715257000705929','20190716140013200396','20190716222000708912','20190716230000709105','20190716234000708358','20190717242000712277','20190717255000711545','20190718160013252646','20190718224000714567','20190718230000715163','20190718233000715219','20190718260000715433','20190718273000715322','20190719263000718363','20190719298000717882','20190722193013293914','20190722212000723064','20190722238000723031','20190722248000722525','20190722297000720975','20190723216000726422','20190723217000725765','20190723241000725271','20190723263000726273','20190723269000725175','20190723283000726354','20190724140013341533','20190724242000728990','20190725169013392133','20190725257000734604','20190725261000734892','20190725294000735037','20190726263000735232','20190727229000737191','20190729270000739136','20190730142011701572','20190730230000740919','20190731145013484932','20190731273000742552','20190801231000744192','20190801294000744174','20190801295000744229','20190802240000746032','20190802258000746062','20190802259000746057','20190802268000746007','20190803287000746063','20190805190013596817','20190805211000749331','20190806146013608266','20190806149013607779','20190807270000753012','20190807291000753028','20190808190013648952','20190808241000756306','20190808251000756065','20190808264000756116','20190808267000756185','20190808285000756327','20190809172013675693','20190810216000758636','20190810231000758517','20190810266000758501','20190812210000760471','20190812231000760497','20190812236000760420','20190812257000760178','20190813231000762123','20190813252000760501','20190814197013775915','20190814259000763494','20190815210000765062','20190815212000765222','20190815226000764292','20190815235000764067','20190815251000765230','20190815269000765213','20190815286000764262','20190816240000766355','20190817236000766918','20190820212000768887','20190821229000770700','20190821236000770625','20190822267000772427','20190822273000772319','20190823293000772648','20190824280000774083','20190824290000774024','20190826251000776378','20190827235000777451','20190827236000775904','20190827236000776904','20190827255000778168','20190827295000778182','20190828118014027652','20190829239000781738','20190829253000781735','20190829263000781708','20190830234000782810','20190904254000789904','20190904265000789816','20190905278000791627','20190905281000790719','20190905281000791361','20190906220000793136','20190909237000795440','20190911268000799198','20190912279000800439','20190912294000800980','20190913247000801828','20190913290000802612','20190916238000805074','20190916290000805164','20190918200000808607','20190918244000808518','20190921218000813007','20190921249000812972','20190925290000818351','20190927286000821893','20191001269000824728','20191003297000830040','20191005258000832376','20191106212000869605');

$h=0;
$i=0;
foreach($pres as $p){    $h++;
    
    $productos=$mipres->GetDireccionamientoPorPrescripcion($p);
    
    
    
    $codigo_sede=GetCodigoSede();
    $nit=GetNitProh();
     
    
    $j=0;
    if(count($productos)==0 || is_null($productos)){
        //echo $h.".- ".$p." NO ENCONTRADO<br>";
    }else{
         echo "<br>".$h.".- ".$p." SI ENCONTRADO<br>";
    } 
    foreach($productos as $pm){ $i++;
        $data['ID']=(INT)$pm['ID'];
        $data['FecMaxEnt']=$pm['FecMaxEnt'];
        $data['TipoIDSedeProv']='NI';
        $data['NoIDSedeProv']=$nit;
        $data['CodSedeProv']=$codigo_sede;
        $data['CodSerTecAEntregar']=$pm['CodSerTecAEntregar'];
        $data['CantTotAEntregar']=$pm['CantTotAEntregar'];
        $respuesta=$mipres->Programacion($data);  
        
        echo "<br>".$i." - ".$pm['ID'];
        if($respuesta[0]['Id']){ $j++;
    	    echo " - IdProgramacion: ".$respuesta[0]['Id']." ";
    	    
            //$lote=GetLoteEntregado($pm['Id_Producto'],$pm["Id_Dispensacion"]);
            $data['ID']=(INT)$pm['ID'];
            $data['CodSerTecEntregado']=$pm['CodSerTecAEntregar'];
            $data['CantTotEntregada']=$pm['CantTotAEntregar'];
            $data['EntTotal']=0;
            $data['CausaNoEntrega']=0;
            $data['FecEntrega']=$pm["FecMaxEnt"];
            $data['NoLote']='00000';
            $data['TipoIDRecibe']='CC';
            $data['NoIDRecibe']= $pm['NoIDPaciente'];
            $entrega=$mipres->ReportarEntrega($data);
            
            if($entrega[0]['Id']){ 
                echo " - IdEntrega: ".$entrega[0]['Id']." ";
                
               /*$data['ID']=(INT)$pm['ID'];
               $data['EstadoEntrega']=1;
               $data['CausaNoEntrega']=0;
               $data['ValorEntregado']= '1';
               $respuesta=$mipres->ReportarEntregaEfectiva($data);
               
                if($respuesta[0]['Id']){
                    echo " - IdReporteEntrega: ".$respuesta[0]['Id']."<br>";
                }else{
                    $error= $respuesta["Errors"][0];
                    echo "<br>";
                }
                */
    
            }else{
               var_dump($entrega); 
            }
            
            
        }else{
            var_dump($respuesta);
            $error= $respuesta["Errors"][0];
            if(strpos($error,"ya fue programado")!==false){
               	echo " - Programado Anterior "; 
            }elseif(strpos($error,"anulado")!==false){
                echo " - Anulado Anterior ";
            }
        }
        
    }
    
         
}

function GetCodigoSede(){
    global $queryObj;
    $query = 'SELECT Codigo_Sede				
        FROM Configuracion
        WHERE Id_Configuracion=1';
    $queryObj->SetQuery($query);
    $dato = $queryObj->ExecuteQuery('simple');
    return $dato['Codigo_Sede'];
}
function GetNitProh(){
    global $queryObj;
    $query = 'SELECT NIT				
            FROM Configuracion
            WHERE Id_Configuracion=1';
    $queryObj->SetQuery($query);
    $dato = $queryObj->ExecuteQuery('simple');

    $n=explode('-',$dato['NIT']);
    $nit=$n[0];
    $nit=str_replace('.','',$nit);
    return $nit;
}

                
                
                
?>